<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Royal English Worksheet V20 - Perfect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&family=Playfair+Display:wght@400;700;900&family=Roboto:wght@400;500;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    :root {
        --primary: #1a2a3a;
        --gold: #c5a059;
        --bg-body: #f0f2f5;
        --col-1-bg: #fdfbf7; 
        --col-3-bg: #f8f9fa;
        --font-head: 'Playfair Display', serif;
        --font-body: 'Roboto', sans-serif;
    }

    body {
        margin: 0; background: var(--bg-body);
        font-family: var(--font-body);
        padding-top: 260px;
        padding-bottom: 50px;
        overflow-x: hidden;
    }

    /* --- Toolbar --- */
    .controls {
        position: fixed; top: 0; left: 0; right: 0;
        z-index: 1000; background: #fff;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border-bottom: 4px solid var(--gold);
    }
    
    .tool-row {
        padding: 5px; display: flex; flex-wrap: wrap; gap: 5px;
        justify-content: center; align-items: center; border-bottom: 1px solid #f0f0f0;
    }
    
    button, select, input[type="text"] {
        padding: 0 10px; height: 32px;
        border: 1px solid #ddd; border-radius: 4px;
        font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 12px;
        background: #fff; cursor: pointer; transition: all 0.2s;
        display: flex; align-items: center; justify-content: center;
    }
    button:hover { background: #f9f9f9; border-color: #bbb; }
    input[type="text"] { cursor: text; width: 100px; text-align: center; color: var(--primary); }

    .btn-main { background: var(--primary); color: #fff; border:none; }
    .btn-gold { background: var(--gold); color: #fff; border:none; }
    .btn-danger { background: #c0392b; color: #fff; border:none; }
    .btn-eco { color: #27ae60; border-color: #27ae60; }
    .btn-toggle { background: #f0f0f0; border: 1px solid #ccc; min-width: 30px; }
    .btn-toggle.active-hide { background: #ccc; color: #555; text-decoration: line-through; }
    
    .separator { width: 1px; height: 20px; background: #ddd; margin: 0 5px; }

    /* Colors */
    .color-dot { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #ccc; cursor: pointer; }
    .color-dot.active { border: 2px solid var(--gold); transform: scale(1.2); }
    .btn-auto { font-size: 10px; background: #eee; width: 35px; height: 24px; border-radius: 4px; cursor: pointer; display:flex; align-items:center; justify-content:center; }

    /* --- Page Layout --- */
    #zoom-area {
        margin-top: 25px; display: flex; justify-content: center;
        transform-origin: top center; transition: transform 0.2s;
    }

    .page {
        direction: ltr; width: 210mm; min-height: 297mm;
        background: #fff; padding: 15mm; margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        position: relative; overflow: hidden;
        display: flex; flex-direction: column;
        border: 1px solid #ccc;
        outline: 2px solid var(--primary); outline-offset: -10px;
    }

    /* --- ECO MODE FIX (Force Black & White) --- */
    body.eco-mode .page {
        outline: 1px solid #000 !important; outline-offset: 0 !important;
        box-shadow: none !important; background: #fff !important;
    }
    body.eco-mode .royal-header { border-bottom-color: #000 !important; }
    body.eco-mode .grid, 
    body.eco-mode .cell, 
    body.eco-mode .box-square, 
    body.eco-mode .box-rect,
    body.eco-mode .circle-box {
        border-color: #000 !important; background: #fff !important; color: #000 !important;
    }
    body.eco-mode .badge, body.eco-mode .brand-box {
        background: #fff !important; color: #000 !important; border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    /* Fix for Bottom Boxes Labels */
    body.eco-mode .box-label-static {
        background: #eee !important; color: #000 !important; 
        border-bottom: 1px solid #000 !important;
    }
    
    body.eco-mode .section-icon { background: #000 !important; }
    body.eco-mode .corner-deco { border-color: #000 !important; }
    body.eco-mode .brand-crown { color: #000 !important; text-shadow: none !important; }
    body.eco-mode .main-title { color: #000 !important; }
    body.eco-mode .watermark-layer { display: none !important; }

    /* --- Brand Banner & Crown --- */
    .brand-container {
        display: none; 
        text-align: center; margin-bottom: 25px; margin-top: 15px;
        position: relative; z-index: 10;
    }
    .brand-wrapper { position: relative; display: inline-block; }
    .brand-crown {
        position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
        font-size: 30px; color: var(--gold); text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        animation: float 3s ease-in-out infinite; pointer-events: none;
    }
    .brand-box {
        background: var(--primary); color: var(--gold);
        font-family: 'Amiri', serif; font-size: 18px; font-weight: bold;
        padding: 5px 40px; border-radius: 10px; border: 2px solid var(--gold);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); min-width: 220px;
    }
    @keyframes float { 0% {top: -35px;} 50% {top: -42px;} 100% {top: -35px;} }

    /* Lines */
    .handwriting-bg {
        background-image: 
            linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
            linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
            linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
            linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px) !important;
        background-size: 100% 30px !important;
        background-position: 0 8px, 0 15px, 0 22px, 0 29px !important;
        line-height: 30px !important;
    }

    /* Watermark */
    .watermark-layer {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 70px; font-weight: 900; 
        color: rgba(0, 0, 0, 0.05); pointer-events: none; 
        font-family: 'Playfair Display', serif; z-index: 5;
        text-transform: uppercase; width: 100%; text-align: center;
    }

    /* Decorations */
    .corner-deco { position: absolute; width: 30px; height: 30px; border: 3px double var(--gold); pointer-events: none; z-index: 2; }
    .top-left { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .top-right { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .bottom-left { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .bottom-right { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    /* Typography */
    [contenteditable] { outline: none; min-height: 1.2em; transition: 0.2s; border-bottom: 1px dashed transparent; position: relative; z-index: 2; }
    [contenteditable]:focus { background: rgba(197, 160, 89, 0.1); border-bottom-color: var(--gold); }

    /* Header */
    .royal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--gold); position: relative; z-index: 2; }
    .header-left, .header-right { width: 25%; font-size: 14px; color: #444; }
    .header-center { flex: 1; text-align: center; margin-top: 10px; }

    .logo-frame { width: 85px; height: 85px; margin: 0 auto 5px; border: 2px double var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background: #fff; }
    .logo-img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .logo-hint { font-size: 10px; color: #999; text-align: center; line-height: 1.2; }

    .main-title { font-family: var(--font-head); font-size: 30px; color: var(--primary); font-weight: 700; margin: 5px 0; }
    .badge { background: var(--primary); color: var(--gold); padding: 2px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; font-family: var(--font-body); }
    .sub-info { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
    .field-box { font-family: var(--font-body); font-size: 13px; color:#333; margin-bottom: 5px; }

    /* Sections & Grid */
    .section-title { display: flex; align-items: center; gap: 10px; margin: 15px 0 10px; color: var(--primary); position: relative; z-index: 2; }
    .section-icon { background: var(--gold); width: 6px; height: 24px; border-radius: 2px; }
    .section-text { font-family: var(--font-head); font-size: 20px; font-weight: 700; border-bottom: 1px solid #eee; width: 100%; }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); border: 2px solid var(--primary); margin-bottom: 20px; position: relative; z-index: 1; }
    .cell { border-bottom: 1px solid #ddd; border-left: 1px solid #ddd; min-height: 48px; padding: 5px 5px 0 5px; display: flex; align-items: center; justify-content: center; text-align: center; word-break: break-word; background: #fff; font-family: var(--font-body); font-size: 18px; }
    .cell:nth-child(4n + 1) { border-left: none; background-color: var(--col-1-bg); font-weight: 600; color: var(--primary); }
    .cell:nth-child(4n + 3) { background-color: var(--col-3-bg); }
    .cell.hidden-content { color: transparent !important; user-select: none; }
    
    /* Bottom */
    .circles-area { display: flex; gap: 15px; margin-bottom: 20px; position: relative; z-index: 2; }
    .circle-box { flex: 1; height: 45px; border: 1px solid var(--gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; background: #fff; font-family: var(--font-body); }

    .bottom-layout { display: flex; gap: 20px; min-height: 120px; margin-bottom: 10px; position: relative; z-index: 2; }
    .box-square { width: 150px; border: 2px solid var(--primary); border-radius: 6px; background: #fff; display: flex; flex-direction: column; }
    .box-rect { flex: 1; border: 2px solid var(--primary); border-radius: 6px; background: #fdfdfd; display: flex; flex-direction: column; }
    .box-label-static { background: rgba(26, 42, 58, 0.05); padding: 5px 10px; font-size: 11px; color: var(--gold); font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #eee; font-family: var(--font-body); user-select: none; }
    .box-content-editable { flex: 1; padding: 10px; font-family: var(--font-body); line-height: 30px; }

    /* Footer */
    .footer { margin-top: auto; padding-top: 10px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
    .teacher-sign { font-family: var(--font-head); font-size: 16px; color: var(--primary); border-bottom: 1px dotted #999; min-width: 100px; }
    .page-badge { background: var(--primary); color: #fff; padding: 4px 15px; border-radius: 20px; font-size: 14px; min-width: 30px; text-align: center; font-family: var(--font-body); }
    .score-stamp { width: 80px; height: 80px; border: 3px double #c0392b; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #c0392b; font-weight: 900; font-size: 24px; transform: rotate(-10deg); background: #fff; }

    /* Popup */
    #bulkPopup { display: none; position: fixed; top: 150px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 2000; border: 2px solid var(--gold); direction: rtl; }

    @media print {
        .controls, #bulkPopup { display: none !important; }
        body { padding: 0; background: #fff; }
        #zoom-area { transform: none !important; margin: 0; display: block; }
        .page { margin: 0; box-shadow: none; width: 100%; page-break-after: always; outline: none; border: 1px solid #ccc; }
    }
</style>
</head>
<body>

<input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleLogo(this)">
<input type="file" id="projectInput" accept=".json" style="display: none;" onchange="loadProject(this)">

<div class="controls">
    <div class="tool-row">
        <select id="rowCount" onchange="updateRows(this.value)">
            <option value="5">5 Rows</option>
            <option value="9">9 Rows</option>
            <option value="11" selected>11 Rows</option>
            <option value="13">13 Rows</option>
        </select>
        <div class="separator"></div>
        <button class="btn-main" onclick="addPage()">‚ûï New</button>
        <select id="targetPage" style="width: 80px; color: var(--primary)"></select>
        <button onclick="copyTargetPage()">üîÅ Copy</button>
        <button class="btn-danger" onclick="delTargetPage()">üóëÔ∏è Del</button>
        <div class="separator"></div>
        <button class="btn-gold" onclick="toggleBulk()">üìù Fill</button>
        <button class="btn-main" onclick="savePDF()">üìÑ PDF</button>
        <button onclick="clearStorage()" style="font-size:10px; color:#c0392b">Reset</button>
    </div>

    <div class="tool-row" style="background:#fff">
        <span style="font-size:11px; color:#555">Hide:</span>
        <button class="btn-toggle" onclick="toggleCol(1, this)">1</button>
        <button class="btn-toggle" onclick="toggleCol(2, this)">2</button>
        <button class="btn-toggle" onclick="toggleCol(3, this)">3</button>
        <button class="btn-toggle" onclick="toggleCol(4, this)">4</button>
        <div class="separator"></div>
        <button onclick="toggleBrand()" title="Show/Hide Brand" class="btn-gold">üëÅÔ∏è Brand</button>
        <button onclick="toggleLines()" title="Handwriting Lines">üìè Lines</button>
        <div class="separator"></div>
        <input type="text" id="wmText" placeholder="Watermark...">
        <button onclick="applyWatermark()" class="btn-gold">Set WM</button>
    </div>
    
    <div class="tool-row" style="background:#fafafa; border-top:1px solid #eee">
        <span style="font-size:11px; color:#555">Font:</span>
        <select onchange="setGlobal('font', this.value)" style="width:100px">
            <option value="">Auto</option>
            <option value="'Roboto', sans-serif">Roboto</option>
            <option value="'Playfair Display', serif">Playfair</option>
            <option value="'Cairo', sans-serif">Cairo</option>
            <option value="'Amiri', serif">Amiri</option>
        </select>
        <select onchange="setGlobal('size', this.value)" style="width:60px">
            <option value="">Size</option>
            <option value="14px">14</option>
            <option value="16px">16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="24px">24</option>
        </select>
        <button id="btnBold" onclick="setGlobal('bold')" style="font-weight:bold; width:30px">B</button>
        <div class="separator"></div>
        <div class="color-dot active" style="background:#000" onclick="setGlobal('color', '#000', this)"></div>
        <div class="color-dot" style="background:#1a2a3a" onclick="setGlobal('color', '#1a2a3a', this)"></div>
        <div class="color-dot" style="background:#3498db" onclick="setGlobal('color', '#3498db', this)"></div>
        <div class="color-dot" style="background:#c0392b" onclick="setGlobal('color', '#c0392b', this)"></div>
        <div class="color-dot" style="background:#27ae60" onclick="setGlobal('color', '#27ae60', this)"></div>
        <div class="btn-auto" onclick="setGlobal('color', 'initial', null)">Auto</div>
        <div class="separator"></div>
        <button onclick="saveProject()">üíæ Save</button>
        <button onclick="document.getElementById('projectInput').click()">üìÇ Load</button>
        <button class="btn-eco" onclick="toggleEco()">üñ®Ô∏è Eco</button>
        <button onclick="document.getElementById('logoInput').click()">üñºÔ∏è Logo</button>
    </div>

    <div class="tool-row" style="background:#fff; border-top:1px dashed #ddd; font-size:10px">
        <span style="color:#999">Sym:</span>
        <button onclick="insertSym('‚úî')" style="min-width:30px">‚úî</button>
        <button onclick="insertSym('‚úò')" style="min-width:30px">‚úò</button>
        <button onclick="insertSym('‚òÖ')" style="min-width:30px">‚òÖ</button>
        <button onclick="insertSym('‚ûú')" style="min-width:30px">‚ûú</button>
    </div>
</div>

<div id="bulkPopup">
    <h3 style="margin-top:0; color:var(--primary)">ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä (Auto-Fill)</h3>
    <textarea id="bulkTxt" rows="6" style="width:100%; padding:8px; border:1px solid #ccc; font-family:'Roboto'" placeholder="Paste English words here..."></textarea>
    <div style="margin-top:15px; display:flex; gap:10px">
        <select id="bulkCol" style="flex:1">
            <option value="0">Column 1 (Main)</option>
            <option value="1">Column 2</option>
            <option value="2">Column 3 (Gray)</option>
            <option value="3">Column 4</option>
        </select>
        <button class="btn-gold" style="flex:1" onclick="runSmartBulk()">Start</button>
        <button class="btn-danger" onclick="toggleBulk()">Cancel</button>
    </div>
</div>

<div id="zoom-area">
    <div id="doc-container">
        <div class="page sheet">
            <div class="corner-deco top-left"></div>
            <div class="corner-deco top-right"></div>
            <div class="corner-deco bottom-left"></div>
            <div class="corner-deco bottom-right"></div>
            <div class="watermark-layer"></div>

            <div class="brand-container">
                <div class="brand-wrapper">
                    <div class="brand-crown">üëë</div>
                    <div class="brand-box" contenteditable="true">English Master Series</div>
                </div>
            </div>

            <div class="royal-header">
                <div class="header-left">
                    <div class="field-box" contenteditable="true">Date: .../.../2026</div>
                    <div class="field-box" contenteditable="true">Class: ..........</div>
                </div>
                <div class="header-center">
                    <div class="logo-frame" onclick="document.getElementById('logoInput').click()" title="Upload Logo">
                        <img src="" class="logo-img">
                        <div class="logo-hint">Upload<br>Logo</div>
                    </div>
                    <div class="main-title" contenteditable="true">English Worksheet</div>
                    <div class="sub-info">
                        <div class="badge" contenteditable="true">Unit 1</div>
                        <div class="badge" contenteditable="true">Lesson 1</div>
                    </div>
                </div>
                <div class="header-right" style="text-align:right">
                    <div class="field-box" style="height:50px" contenteditable="true">Student Name:<br>....................</div>
                </div>
            </div>

            <div class="section-title">
                <div class="section-icon"></div>
                <div class="section-text" contenteditable="true">Vocabulary & Words</div>
            </div>

            <div class="grid"></div>

            <div class="section-title">
                <div class="section-icon" style="background:var(--primary)"></div>
                <div class="section-text" contenteditable="true">Grammar & Notes</div>
            </div>

            <div class="circles-area">
                <div class="circle-box" contenteditable="true">Note 1</div>
                <div class="circle-box" contenteditable="true">Note 2</div>
                <div class="circle-box" contenteditable="true">Note 3</div>
            </div>

            <div class="bottom-layout">
                <div class="box-square">
                    <div class="box-label-static" contenteditable="true">Keywords</div>
                    <div class="box-content-editable" contenteditable="true"></div>
                </div>
                <div class="box-rect">
                    <div class="box-label-static" contenteditable="true">Sentences & Examples</div>
                    <div class="box-content-editable" contenteditable="true"></div>
                </div>
            </div>

            <div class="footer">
                <div>
                    <div style="font-size:10px; color:#888">Teacher:</div>
                    <div class="teacher-sign" contenteditable="true">Mr. Ahmed</div>
                </div>
                <div class="page-badge" contenteditable="true">Page 1</div>
                <div class="score-stamp">
                    <span style="font-size:10px; font-weight:normal; display:block; margin-bottom:-5px">SCORE</span>
                    <div contenteditable="true">/10</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let style = { color: '', size: '', font: '', weight: 'normal' };
    let rowsNum = 11;
    let uploadedLogoData = null;
    let watermarkText = "";
    let hiddenCols = [0, 0, 0, 0];
    let showLines = false;
    let showBrand = false;

    const SAVE_KEY = 'worksheet_v20_final'; // NEW KEY

    function saveState() {
        const state = {
            html: document.getElementById('doc-container').innerHTML,
            rows: rowsNum,
            logo: uploadedLogoData,
            wm: watermarkText,
            lines: showLines,
            brand: showBrand
        };
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    }
    
    function loadState() {
        const saved = localStorage.getItem(SAVE_KEY);
        if(saved) {
            const data = JSON.parse(saved);
            document.getElementById('doc-container').innerHTML = data.html;
            rowsNum = data.rows || 11;
            document.getElementById('rowCount').value = rowsNum;
            uploadedLogoData = data.logo;
            watermarkText = data.wm;
            document.getElementById('wmText').value = watermarkText || "";
            showLines = data.lines;
            showBrand = data.brand;
            updateAfterChange();
        }
    }

    function clearStorage() {
        if (!confirm("‚ö† ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿ¥Ÿäÿ° ŸàÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØÿü")) return;

        // ÿßŸÖÿ≥ÿ≠ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ
        localStorage.removeItem(SAVE_KEY);

        // ÿ±ÿ¨Ÿëÿπ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ≠ÿßŸÑÿ™Ÿáÿß ÿßŸÑÿ£ŸàŸÑŸâ ÿ®ÿØŸàŸÜ reload (ÿ¢ŸÖŸÜ ÿπŸÑŸâ Android)
        const container = document.getElementById('doc-container');
        const firstPage = container.querySelector('.sheet').cloneNode(true);

        container.innerHTML = '';
        container.appendChild(firstPage);

        // ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        rowsNum = 11;
        hiddenCols = [0,0,0,0];
        showLines = false;
        showBrand = false;
        watermarkText = '';
        uploadedLogoData = null;

        document.getElementById('rowCount').value = 11;
        document.getElementById('wmText').value = '';

        buildGrid(firstPage, false);
        updateAfterChange();
        fitZoom();
    }

    document.addEventListener('keyup', saveState);
    document.addEventListener('click', saveState);
    window.addEventListener('load', () => { loadState(); fitZoom(); });

    function toggleBrand() {
        showBrand = !showBrand;
        updateAfterChange();
    }

    function updatePageSelect() {
        const select = document.getElementById('targetPage');
        const count = document.querySelectorAll('.sheet').length;
        const currentVal = select.value;
        select.innerHTML = "";
        for(let i=0; i<count; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.text = `Page ${i+1}`;
            select.appendChild(opt);
        }
        if(currentVal !== "" && currentVal < count) select.value = currentVal;
        else select.value = count - 1;
    }

    function updateAfterChange() {
        updatePageSelect();
        document.querySelectorAll('.sheet').forEach((s,i) => {
            const badge = s.querySelector('.page-badge');
            if(badge.innerText.match(/Page \d+/)) badge.innerText = "Page " + (i+1);
            
            const wm = s.querySelector('.watermark-layer');
            if(wm) wm.innerText = watermarkText;
            
            const brand = s.querySelector('.brand-container');
            if(brand) brand.style.display = showBrand ? 'block' : 'none';

            refreshHiddenCols(s);
            refreshLines(s);
        });
    }

    function toggleLines() {
        showLines = !showLines;
        document.querySelectorAll('.sheet').forEach(s => refreshLines(s));
    }
    function refreshLines(sheet) {
        const targets = sheet.querySelectorAll('.cell, .box-content-editable');
        targets.forEach(t => {
            if(showLines) t.classList.add('handwriting-bg');
            else t.classList.remove('handwriting-bg');
        });
    }

    function insertSym(sym) {
        document.execCommand('insertText', false, sym);
    }

    function addPage() {
        const area = document.getElementById('doc-container');
        const clone = area.firstElementChild.cloneNode(true);
        clone.querySelectorAll('.cell').forEach(c => { c.innerText=""; c.removeAttribute('style'); });
        clone.querySelectorAll('.box-content-editable').forEach(d => d.innerText = "");
        if(uploadedLogoData) {
             const img = clone.querySelector('.logo-img');
             img.src = uploadedLogoData; img.style.display = 'block';
             clone.querySelector('.logo-hint').style.display='none';
        }
        area.appendChild(clone);
        updateAfterChange();
        setTimeout(() => { clone.scrollIntoView({behavior:'smooth'}); fitZoom(); }, 100);
        return clone;
    }

    function copyTargetPage() {
        const idx = document.getElementById('targetPage').value;
        const sheets = document.querySelectorAll('.sheet');
        if(sheets[idx]) {
            const clone = sheets[idx].cloneNode(true);
            sheets[idx].after(clone);
            updateAfterChange();
            document.getElementById('targetPage').value = parseInt(idx) + 1;
            clone.scrollIntoView({behavior:'smooth'});
        }
    }

    function delTargetPage() {
        const idx = document.getElementById('targetPage').value;
        const sheets = document.querySelectorAll('.sheet');
        if(sheets.length <= 1) return alert("Cannot delete the last page.");
        if(sheets[idx] && confirm(`Delete Page ${parseInt(idx)+1}?`)) {
            sheets[idx].remove();
            updateAfterChange();
        }
    }

    function applyWatermark() {
        watermarkText = document.getElementById('wmText').value;
        updateAfterChange();
    }

    function toggleCol(colNum, btn) {
        const colIdx = colNum - 1;
        hiddenCols[colIdx] = hiddenCols[colIdx] ? 0 : 1;
        if(hiddenCols[colIdx]) btn.classList.add('active-hide');
        else btn.classList.remove('active-hide');
        document.querySelectorAll('.sheet').forEach(s => refreshHiddenCols(s));
    }

    function refreshHiddenCols(sheet) {
        const cells = sheet.querySelectorAll('.cell');
        cells.forEach((cell, i) => {
            const colIndex = i % 4;
            if(hiddenCols[colIndex]) cell.classList.add('hidden-content');
            else cell.classList.remove('hidden-content');
        });
    }

    function setGlobal(p, v, btn) {
        if(p==='color') {
            style.color = v;
            document.querySelectorAll('.color-dot').forEach(b => b.classList.remove('active'));
            if(btn && v !== 'initial') btn.classList.add('active');
        }
        if(p==='size') style.size = v;
        if(p==='font') style.font = v;
        if(p==='bold') {
            style.weight = (style.weight==='normal')?'bold':'normal';
            document.getElementById('btnBold').style.background = (style.weight==='bold')?'#eee':'#fff';
        }
    }

    document.addEventListener('focusin', e => {
        if(e.target.isContentEditable) {
            if(style.color === 'initial') e.target.style.color = '';
            else if(style.color) e.target.style.color = style.color;
            if(style.size) e.target.style.fontSize = style.size;
            if(style.font) e.target.style.fontFamily = style.font;
            if(style.weight !== 'normal') e.target.style.fontWeight = style.weight;
        }
    });

    function buildGrid(sheet, keep=true) {
        const grid = sheet.querySelector('.grid');
        let saved = [];
        if(keep) sheet.querySelectorAll('.cell').forEach(c => saved.push({h:c.innerHTML, s:c.getAttribute('style')}));
        grid.innerHTML = "";
        for(let i=0; i<rowsNum; i++) {
            for(let c=0; c<4; c++) {
                let d = document.createElement('div');
                d.className = 'cell'; d.contentEditable = true;
                let idx = (i*4)+c;
                if(keep && saved[idx]) {
                    d.innerHTML = saved[idx].h;
                    if(saved[idx].s) d.setAttribute('style', saved[idx].s);
                }
                grid.appendChild(d);
            }
        }
        refreshHiddenCols(sheet);
        refreshLines(sheet);
    }
    buildGrid(document.querySelector('.sheet'), false);
    updateAfterChange();

    function updateRows(v) {
        rowsNum = parseInt(v);
        document.querySelectorAll('.sheet').forEach(s => buildGrid(s, true));
    }

    function toggleEco() { document.body.classList.toggle('eco-mode'); }

    function saveProject() {
        const content = {
            html: document.getElementById('doc-container').innerHTML,
            rows: rowsNum,
            logo: uploadedLogoData,
            wm: watermarkText,
            brand: showBrand
        };
        const blob = new Blob([JSON.stringify(content)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "worksheet_project.json";
        a.click();
    }

    function loadProject(input) {
        if(input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const data = JSON.parse(e.target.result);
                document.getElementById('doc-container').innerHTML = data.html;
                rowsNum = data.rows || 11;
                document.getElementById('rowCount').value = rowsNum;
                if(data.logo) uploadedLogoData = data.logo;
                if(data.wm) { watermarkText = data.wm; document.getElementById('wmText').value = data.wm; }
                showLines = data.lines;
                showBrand = data.brand;
                updateAfterChange();
            };
            r.readAsText(input.files[0]);
        }
    }

    function handleLogo(input) {
        if (input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                uploadedLogoData = e.target.result;
                document.querySelectorAll('.logo-img').forEach(img => {
                    img.src = e.target.result; img.style.display = 'block';
                });
                document.querySelectorAll('.logo-hint').forEach(h => h.style.display='none');
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function toggleBulk() {
        const p = document.getElementById('bulkPopup');
        p.style.display = (p.style.display==='block')?'none':'block';
    }

    function runSmartBulk() {
        const txt = document.getElementById('bulkTxt').value;
        const words = txt.split('\n').filter(w=>w.trim());
        const col = parseInt(document.getElementById('bulkCol').value);
        let ptr = 0;
        document.querySelectorAll('.sheet').forEach(s => {
            const cells = s.querySelectorAll('.cell');
            for(let i=0; i<cells.length; i++) {
                if(ptr<words.length && i%4===col && cells[i].innerText.trim()==="") {
                    cells[i].innerText = words[ptr]; ptr++;
                }
            }
        });
        while(ptr < words.length) {
            const ns = addPage();
            const cells = ns.querySelectorAll('.cell');
            for(let i=0; i<cells.length; i++) {
                if(ptr<words.length && i%4===col) {
                    cells[i].innerText = words[ptr]; ptr++;
                }
            }
        }
        toggleBulk();
    }

    function fitZoom() {
        const w = window.innerWidth;
        const wrap = document.getElementById('zoom-area');
        if(w<820) {
            const s = (w/820)*0.96;
            wrap.style.transform = `scale(${s})`;
            wrap.style.height = (document.getElementById('doc-container').offsetHeight*s)+"px";
        } else {
            wrap.style.transform = "none";
            wrap.style.height = "auto";
        }
    }
    window.onresize = fitZoom;

    // --- Fixed PDF (New Robust Method) ---
    async function savePDF() {
        const wrap = document.getElementById('zoom-area');
        const t = wrap.style.transform;
        
        // 1. Reset Zoom & Scroll to Top
        wrap.style.transform = "none";
        window.scrollTo(0, 0); 
        
        const btn = document.querySelector("button[onclick='savePDF()']");
        const oldText = btn.innerText;
        btn.innerText = "‚è≥ Processing...";
        
        // Small delay to allow rendering
        await new Promise(r => setTimeout(r, 200));

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p','mm','a4');
            const sheets = document.querySelectorAll('.sheet');
            
            for(let i=0; i<sheets.length; i++) {
                if(i>0) doc.addPage();
                
                // 2. Capture
                const canvas = await html2canvas(sheets[i], {
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                doc.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            }
            doc.save('Royal_Worksheet.pdf');
            alert("‚úÖ PDF Saved Successfully!");
        } catch (err) {
            alert("‚ùå Error: " + err.message);
            console.error(err);
        } finally {
            btn.innerText = oldText;
            wrap.style.transform = t; 
            fitZoom(); 
        }
    }
</script>

</body>
</html>
